---
layout: _post
title: TCP连接管理与保活机制
date: 2019-06-03 23:45:57
tags: TCP
---
这是读《TCP/IP》的笔记之一，很多内容都是书上看的，然后图片是根据书中的内容绘制出来的。
ps：TCP/IP这本书，真的有点厚，不知道什么时候能看完。
# TCP报文结构

![TCP报文结构](http://static.kaolagogogo.fun/blogimage/TCP%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84.jpg "TCP报文结构")
<!-- 插入图片 -->
TCP头部结构
![TCP头部结构](http://static.kaolagogogo.fun/blogimage/TCP%E5%A4%B4%E9%83%A8%E7%BB%93%E6%9E%84.jpg "TCP报文结构")


<!-- 插入图片 -->
每个字段的含义 
`CWR`:通知接收方，已将拥塞窗口缩小（跟下面的ECE一起用）
`ECE`:通知接收方，接收方到这边的网络有阻塞
`URG`:头部的紧急指针是否有效
`ACK`:响应
`PSH`:不缓存，马上处理
`RST`:连接重置
`SYN`:建立连接
`FIN`:关闭连接

# TCP连接管理
以上内容解释完之后，来看一下TCP为什么是`安全可靠`的

首先是连接的过程，采用了我们耳熟能详的“三次握手”，
请看下面这张图片
![三次握手](
http://static.kaolagogogo.fun/blogimage/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.jpg "三次握手")
解释一下其中的几个状态: 
* SYN-SENT:客户端在发送一个连接请求之后，收到应答之前的状态
* SYN-RECEIVED (SYN_RCVD)：服务端在接收到一个连接请求和发送一个链接请求之后，收到应答之前的状态
第一次和第二次握手可以保证客户端向服务端发送数据是可靠的
第二次和第三次握手可以保证服务端向客户端发送数据是可靠的

断开连接过程，采用的是“四次挥手”
![四次挥手](http://static.kaolagogogo.fun/blogimage/TCP%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B.jpg "四次挥手")
解释一下其中的几个状态
* FIN_WAIT_1  客户端发出断开连接的请求后，等待ack回复的状态 
* CLOSE_WAIT  服务端等待对方的断开连接请求 
* FIN_WAIT_2  等到服务端的断开请求
* LAST_ASK 服务端发出FIN后 等待客户端的响应
* TIME_WAIT 客户端收到服务端的FIN 发出ACK之后 等待一段时间（防止这个ACK包没有成功发送）


 # 保活
 ## 过程
发送端开启保活功能
1. 在保活时间内如果处于非活动状态，发送保活探测报文
2. 如果没有响应，则经过保活时间间隔之后继续发送，直到达到上限（这里的上限指的是保活探测数）
3. 如果没有响应，则认为数据无法到达，连接将被断开
4. 保活探测报文为空报文或一个字节的报文，序列号为接收端发送的ACK报文的最大序列号减1（原因：这个序列号接收端已经收到 所以不会影响之前的数据）

## 结果
1. 接收端仍在工作，并响应了探测报文
2. 接收端已断开
3. 接收端重启了
4. 接收端仍在工作，但因为某种原因没有收到ACK